app.controller("gestaoCadastroColaboradorController", [
		"$filter",
		"$scope",
		"$cookies",
		"api",
		function($filter, $scope, $cookies, api) {
			$scope.usuario = $cookies.getObject('usuario');
			$scope.tela = new Tela($scope);
			$scope.tabela = new gestaoCadastroColaboradorController_tabela(api, $scope);
			$scope.detalhe = new gestaoCadastroColaboradorController_detalhe(api, $scope);
			
			$scope.tabela.carregarEmpresa();
			$scope.tela.ativar('tabela');
			
} ]);


function gestaoCadastroColaboradorController_detalhe(aApi, aScope){
	var _root = this;
	this.colaborador = {};
	
	this.init = function(aColaborador){
		_root.colaborador = aColaborador;
		aScope.tela.ativar("detalhe");
	}
}
function gestaoCadastroColaboradorController_tabela(aApi, aScope){
	var _root = this;
	this.aba = 0;
	this.colaborador = {};
	this.lista = [];
	this.listEmpresa = [];
	this.listaCentroDeCusto = [];
	this.listaColaborador = [];
	this.busca = {colaborador:'', empresa:'', centroDeCusto:''};
	this.apoio = {
		uf:[],//estática
		estadoCivil:[],//estática
		sexo:[],//estática
		cargo:[],//estática
		situacao:[],//estática
		turno:[],//estática
		tipoContratacao:[],//estática
		origemDosRecursos:["INTERNO","PROJETO"],//estática
		sindicato:[]//estática
	}
	
	/**
	 * Gera a lista do colaboradores
	 */
	this.init = function(){
		_root.buscarCentroDeCusto('');
		aApi.enviarApi("Colaborador.buscar",1,_root.busca)
		.success(function(aResp){
			if(aResp.error){
				alertaError(aResp.error.message + " :: " + aResp.error.code);
				return;
			}
			_root.lista = aResp.result;
			
		});
		
		//busca as tabelas de apoio que são estáticas e de acesso livre
		aApi.enviarApi("Colaborador.apoioEstatico",1,'')
		.success(function(aResp){
			if(aResp.error){
				alertaError(aResp.error.message + " :: " + aResp.error.code);
				return;
			}
			_root.apoio.uf = aResp.result.uf;
			_root.apoio.estadoCivil = aResp.result.estadoCivil;
			_root.apoio.sexo = aResp.result.sexo;
			_root.apoio.cargo = aResp.result.cargo;
			_root.apoio.situacao = aResp.result.situacao;
			_root.apoio.turno = aResp.result.turno;
			_root.apoio.tipoContratacao = aResp.result.tipoContratacao;
			_root.apoio.sindicato = aResp.result.sindicato;
		});
	}

	/**
	 * Carrega a lista de empresas e suas respectivas filiais
	 */
	this.carregarEmpresa = function(){
		aApi.enviarApi("Colaborador.consultarEmpresa",1,'')
		.success(function(aResp){
			if(aResp.error){
				alertaError(aResp.error.message + " :: " + aResp.error.code);
				return;
			}
			
			_root.listEmpresa = aResp.result;
			_root.listaCentroDeCusto = [];
			_root.apoio.empresa = _root.listEmpresa;
		});
	}
	
	/**
	 * Carrega a lista de centros de custo
	 */
	this.buscarCentroDeCusto = function(aNomeCentroDeCusto){
		aApi.enviarApi("Colaborador.consultarCentroDeCusto",1,{
				empresa:_root.busca.empresa,
				centroDeCusto:aNomeCentroDeCusto
		})
		.success(function(aResp){
			if(aResp.error){
				alertaError(aResp.error.message + " :: " + aResp.error.code);
				return;
			}
			_root.listaCentroDeCusto = aResp.result;
			_root.listaCentroDeCusto.unshift({id:'', nome:''});
		});
	}
	
	/**
	 * Carrega a lista de centros de custo
	 */
	this.buscarColaborador = function(aNomeColaborador){
		aApi.enviarApi("Colaborador.consultarColaborador",1,{
			empresa:_root.busca.empresa,
			centroDeCusto: _root.busca.centroDeCusto,
			colaborador: aNomeColaborador
		})
		.success(function(aResp){
			if(aResp.error){
				alertaError(aResp.error.message + " :: " + aResp.error.code);
				return;
			}
			_root.listaColaborador = aResp.result;
		});
	}
	
	/**
	 * Limpa as tabelas de centro de custo e colaborador
	 */
	this.limparColaboradorAndCentroDeCusto = function(){
		_root.listaColaborador = [];
		_root.listaCentroDeCusto = [];
		_root.busca.colaborador = '';
		_root.busca.centroDeCusto = '';
	}
	
	/**
	 * Limpa o formulário de busca
	 */
	this.limparBusca = function(){
		_root.listaColaborador = [];
		_root.lista = [];
		_root.listaCentroDeCusto = [];
		_root.busca.colaborador = '';
		_root.busca.centroDeCusto = '';
		_root.busca.empresa = '';
	}
	
	/**
	 * Envia os dados editados para o banco de dados
	 */
	this.salvar = function(){
		aApi.enviarApi("Colaborador.salvar",1,_root.colaborador)
		.success(function(aResp){
			if(aResp.error){
				alertaError(aResp.error.message + " :: " + aResp.error.code);
				return;
			}
			_root.init();
			aScope.tela.ativar('tabela');
		});
	}
	
	/**
	 * Inicia a edição de um novo colaborador
	 */
	this.editar = function(aIdColaborador){
		aApi.enviarApi("Colaborador.colaboradorParaEditar",1,aIdColaborador)
		.success(function(aResp){
			if(aResp.error){
				alertaError(aResp.error.message+" :: "+aResp.error.code);
				return;
			}
			_root.colaborador = aResp.result;
			for(var i in _root.apoio.uf){
				if(_root.colaborador.ufEmissorId == null){
					break;
				}
				var uf = _root.apoio.uf[i];
				if(_root.colaborador.ufEmissorId.id == uf.id){
					_root.colaborador.ufEmissorId = _root.apoio.uf[i];
				} 
				if(_root.colaborador.ufResId.id == uf.id){
					_root.colaborador.ufResId = _root.apoio.uf[i];
				} 
				if(_root.colaborador.ctpsUfId.id == uf.id){
					_root.colaborador.ctpsUfId = _root.apoio.uf[i];
				} 
			}
			
			for(var i in _root.apoio.estadoCivil){
				if(_root.colaborador.estadoCivilId == null){
					break;
				}
				if(_root.colaborador.estadoCivilId.id == _root.apoio.estadoCivil[i].id){
					_root.colaborador.estadoCivilId = _root.apoio.estadoCivil[i];
				} 
			}
			for(var i in _root.apoio.sexo){
				if(_root.colaborador.sexoId == null){
					break;
				}
				if(_root.colaborador.sexoId.id == _root.apoio.sexo[i].id){
					_root.colaborador.sexoId = _root.apoio.sexo[i];
				} 
			}
			for(var i in _root.apoio.cargo){
				if(_root.colaborador.cargoId == null){
					break;
				}
				if(_root.colaborador.cargoId.id == _root.apoio.cargo[i].id){
					_root.colaborador.cargoId = _root.apoio.cargo[i];
				} 
			}
			for(var i in _root.listEmpresa){
				if(_root.colaborador.empresaId == null){
					break;
				}
				if(_root.colaborador.empresaId.id == _root.listEmpresa[i].id){
					_root.colaborador.empresaId = _root.listEmpresa[i];
				} 
			}
			
			if(_root.colaborador.filialId != null){
				for(var i in _root.colaborador.empresaId.listFilial){
					if(_root.colaborador.filialId.id == _root.colaborador.empresaId.listFilial[i].id){
						_root.colaborador.filialId = _root.colaborador.empresaId.listFilial[i];
					} 
				}
			}
			
			var temCentroDeCusto = false;
			for(var i in _root.listaCentroDeCusto){
				if(_root.colaborador.centroDeCustoId == null){
					break;
				}
				if(_root.colaborador.centroDeCustoId.id == _root.listaCentroDeCusto[i].id){
					_root.colaborador.centroDeCustoId = _root.listaCentroDeCusto[i];
					temCentroDeCusto = true;
				} 
			}
			
			if(!temCentroDeCusto){
				 _root.listaCentroDeCusto.unshift(_root.colaborador.centroDeCustoId);
				 _root.colaborador.centroDeCustoId = _root.listaCentroDeCusto[0];
			}
			
			if(_root.colaborador.centroDeCustoId != null){
				for(var i in _root.colaborador.centroDeCustoId.hierarquia){
					if(_root.colaborador.hierarquiaId == null){
						break;
					}
					if(_root.colaborador.hierarquiaId.id == _root.colaborador.centroDeCustoId.hierarquia[i].id){
						_root.colaborador.hierarquiaId = _root.colaborador.centroDeCustoId.hierarquia[i];
					}
				}
			}
			for(var i in _root.apoio.situacao){
				if(_root.colaborador.situacaoId == null){
					break;
				}
				if(_root.colaborador.situacaoId.id == _root.apoio.situacao[i].id){
					_root.colaborador.situacaoId = _root.apoio.situacao[i];
				}
			}
			for(var i in _root.apoio.turno){
				if(_root.colaborador.turnoId == null){
					break;
				}
				if(_root.colaborador.turnoId.id == _root.apoio.turno[i].id){
					_root.colaborador.turnoId = _root.apoio.turno[i];
				}
			}
			for(var i in _root.apoio.sindicato){
				if(_root.colaborador.sindicatoId == null){
					break;
				}
				if(_root.colaborador.sindicatoId.id == _root.apoio.sindicato[i].id){
					_root.colaborador.sindicatoId = _root.apoio.sindicato[i];
				}
			}
			for(var i in _root.apoio.tipoContratacao){
				if(_root.colaborador.tipoContratacaoId == null){
					break;
				}
				if(_root.colaborador.tipoContratacaoId.id == _root.apoio.tipoContratacao[i].id){
					_root.colaborador.tipoContratacaoId = _root.apoio.tipoContratacao[i];
				}
			}
			_root.aba = 0;
			aScope.tela.ativar('edita');
		})
	}
}