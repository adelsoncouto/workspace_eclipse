<?php

class Main{
	
	/** @var \PDO $pdo */
	private $pdo;
	
	private $tabela;
	
	public function __construct($aTabela) {
		$this->tabela = $aTabela;		
		$this->pdo = new PDO('mysql:host='.@getenv('MYSQL_HOST').';dbname='.@getenv('MYSQL_BANCO_GM'), @getenv('MYSQL_USUARIO'), @getenv('MYSQL_SENHA'), array(PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES utf8"));
		$this->pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
		$this->pdo->setAttribute(PDO::ATTR_ORACLE_NULLS, PDO::NULL_EMPTY_STRING);
		$this->pdo->setAttribute(PDO::ATTR_PERSISTENT, true);
	}
	
	public function __destruct(){
		$this->pdo = null;
	}
	
	public function gerarObjetoJs(){
		$pst = $this->pdo->prepare("desc ".$this->tabela);
		$pst->execute();
		$attr = "";
		$params = "";
		$parse = "";
		$obj = "";
		
		while($row = $pst->fetch(\PDO::FETCH_ASSOC)){
			//Field Type Null Key Default Extra
			foreach ($row as $kRow=>$vRow){
				if($kRow == "Field"){
					if($params != ""){
						$params .= ", ";
					}
					
					$parse .= "\n\t\t_this.".$this->underlineToMaiuscula($row["Field"])." = ";
					$parse .= "(a".$this->underlineToMaiuscula($row["Field"], true)." === undefined)?_this.";
					$parse .= $this->underlineToMaiuscula($row["Field"]).":";
					$parse .= "a".$this->underlineToMaiuscula($row["Field"], true).";";
					$attr .= "\n\tthis.".$this->underlineToMaiuscula($row["Field"])." = \"\";";
					$params .= "a".$this->underlineToMaiuscula($row["Field"], true);
					$obj .= "\n\t\t_obj.".$this->underlineToMaiuscula($row["Field"])
						." = _this.".$this->underlineToMaiuscula($row["Field"]).";";
				}
			}
		}
		
		
		$salvar = "
	this.salvar = function(){
		//TODO: Informe a api que vai salvar o objeto
		aApi.enviarApi(\"\",1,_this.toJson())
		.success(function(aResp){
			if(aResp.error){
				alertaAtencao(aResp.error.message);
				return;
			}
			alertaSuccess(\"Salvo com sucesso!\");
		})
		.error(function(aResp){
			alertaAtencao(aResp);
		})
	}
				";
		$toJson = "
	this.toJson = function(){
		var _obj = {};".$obj."
		return _obj;			
	}
				";
		$obj = "function Model".$this->underlineToMaiuscula($this->tabela, true)."(".$params."){";
		$obj .= "\n\tvar _this = this;";
		$obj .= "\n\tthis.lista = [];";
		$obj .= $attr;
		$obj .= "\n\n\t(function(){";
		$obj .= $parse;
		$obj .= "\n\t})();";
		$obj .= $salvar;
		$obj .= $toJson;
		$obj .= "\n}";
		echo $obj;
	}
	
	public function maiusculaToUnderline($aString = ""){
		$txt = "";
		$letras = str_split($aString);
		foreach ($letras as $k => $v){
				
			if(preg_match("/(\W|_)+/", $v)){
				$txt .= $v;
				continue;
			}
				
			if($k == 0){
				$v = strtolower($v);
			}
				
			if(strcmp($v, strtoupper($v)) == 0){
				$v = "_".strtolower($v);
			}
				
			$txt .= $v;
		}
	
		return $txt;
	}
	
	public function underlineToMaiuscula($aString = "", $aPrimeiraMaiuscula = false){
		$txt = "";
		$letras = str_split($aString);
		$muda = false;
		$primeiraLetra = true;
		foreach ($letras as $k => $v){
			if($muda){
				$muda = false;
				$v = strtoupper($v);
			}
				
			if($v === "_"){
				$muda = true;
			}else{
	
				if($primeiraLetra){
					if($aPrimeiraMaiuscula){
						$v = strtoupper($v);
					}else{
						$v = strtolower($v);
					}
					$primeiraLetra = false;
				}
	
				$txt .= $v;
			}
		}
	
		return $txt;
	}

	public function gerarForm(){
		
		$form = "";		
		$input = "";
		
		$pst = $this->pdo->prepare("desc ".$this->tabela);
		$pst->execute();
		while($row = $pst->fetch(\PDO::FETCH_ASSOC)){
			//Field Type Null Key Default Extra
			foreach ($row as $kRow=>$vRow){
				if($kRow == "Field"){
					$input .= "\n<div>";
					$input .= "\n<label>".$this->underlineToMaiuscula($row["Field"])."</label>";
					$input .= "\n<input type=\"text\"" 
							." data-ng-model=\""
							.$this->underlineToMaiuscula($this->tabela)."."
							.$this->underlineToMaiuscula($row["Field"])."/>";
					$input .= "\n</div>";
				}
			}
		}
		$form .= $input;
		echo $form;
	}
	
}

$tabela = "habilidade";
$main = new Main($tabela);
// $main->gerarObjetoJs();
$main->gerarForm();