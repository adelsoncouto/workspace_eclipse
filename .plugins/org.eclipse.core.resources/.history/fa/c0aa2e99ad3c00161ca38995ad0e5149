app.controller("dashboardFinanceiroController", [
		"$filter",
		"$scope",
		"$cookies",
		"api",
		function($filter, $scope, $cookies, api) {
			$scope.usuario = $cookies.getObject('usuario');

			//gráficos
			$scope.grafico = new dashboardFinanceiroController_grafico(api);
			
			//gerencia a tela a ser exibida
			$scope.tela = new Tela($scope);
			$scope.tela.ativar('tabela');
			
}]);


function dashboardFinanceiroController_grafico(aApi) {
	var _this = this;
	
	//referencias ao timesheet
	this.timesheet = {};
	this.listaTimesheet = [];
	
	//séries de dados
	this.serieBarra = [];
	this.seriePizza = [];
	this.serieCentroDeCusto = [];
	
	/**
	 * Função responsável por listar os timesheet
	 */
	this.carregarTimesheet = function(){
		aApi.enviarApi("DashboardTimesheet.financeiroListarTimesheet",
			1)
		.success(function(aResp){
			if(aResp.error){
				alertaError(aResp.error.message);
				return;
			}
			_this.listaTimesheet = aResp.result;
		})
		.error(function(aResp){
			alertaError(aResp);
		})
	}
	
	/**
	 * Função resposável por carregar os dados gerais dos gráficos
	 */
	this.init = function(){
		aApi.enviarApi("DashboardTimesheet.financeiroExtraAndSobreaviso",
			1, _this.timesheet)
		.success(function(aResp){
			if(aResp.error){
				alertaError(aResp.error.message);
				return;
			}
			
			_this.serieBarra = aResp.result.barra;
			_this.seriePizza = aResp.result.pizza;
			
		})
		.error(function(aResp){
			alertaError(aResp);
		})
	}
	
	/**
	 * Função responsável por carregar os dados de um centro de custo
	 */
	this.detalhar = function(){
		//TODO:
	}
	
	/**
	 * Função responsável por renderizar o gráfico de pizza
	 */
	this.renderizarPizza = function(){
	    $('#pizza').highcharts({
	        chart: {
	            plotBackgroundColor: null,
	            plotBorderWidth: null,
	            plotShadow: false,
	            type: 'pie'
	        },
	        title: {
	            text: 'Custo de horas extras e sobreavisos'
	        },
	        tooltip: {
            	pointFormatter:function(){
                	return '<b>'+this.name+'</b>: R$ '+this.y.toLocaleString('pt-BR',{minimumFractionDigits: 2,maximumFractionDigits: 2});
                }
	        },
	        plotOptions: {
	            pie: {
	                allowPointSelect: true,
	                cursor: 'pointer',
	                dataLabels: {
	                    enabled: true,
	                    formatter:function(){
	                    	return '<b>'+this.key+'</b>: R$ '+this.y.toLocaleString('pt-BR',{minimumFractionDigits: 2,maximumFractionDigits: 2});
	                    }
	                }
	            }
	        },
	        series: [{
	            name: 'Custo',
	            data: [
                   {
                	   name: 'Horas extras',
                	   y: 56.33
                   }, 
                   {
                	   name: 'Sobreaviso',
                	   y: 24.03
                   }
	            ]
	        }]
	    });
	    _this.barra();
    }

	/**
	 * Função responsável por renderizar o gráfico de barras geral
	 */
	this.renderizarBarra = function(){
		 $('#barra').highcharts({
			 chart: {
	            zoomType: 'xy',
	            options3d: {
	                enabled: true,
	                alpha: 45,
	                beta: 0
	            }
	        },
	        plotOptions: {
	        	series: {
	                cursor: 'pointer',
                	events: {
                		click: function (e) {
                			_this.detalhar(e.point.category);
                		}	
                	}
	            }
	        },
	        title: {
	            text: 'Custo de horas extras e sobreavisos no timesheet 06/2016'
	        },
	        xAxis: [{
	            categories: ['Aa', 'Bb', 'Cc', 'Dd', 'Ee', 'Ff',
	                'Gg', 'Hh', 'Ii', 'Jj', 'Kk', 'Ll'],
	            crosshair: true
	        }],
	        yAxis: [{
	            title: {
	                text: 'Custo'
	            }
	        }, {
	            title: {
	                text: 'Colaboradores'
	            },
	            opposite: true
	        }],
	        tooltip: {
	            shared: true
	        },
	        series: [
                 {
                	 name: 'Hora extra',
                	 type: 'column',
                	 stacking: 'normal',
                	 stack: 'custo',
                	 data: [105,115,125,135,145,155,165,175,185,195,205,215]
                 },
                 {
                	 name: 'Sobreaviso',
                	 type: 'column',
                	 stacking: 'normal',
                	 stack: 'custo',
                	 data: [100,110,120,130,140,150,160,170,180,190,200,210]
                 },
                 {
                	 name: 'Do centro de custo',
                	 type: 'column',
                	 stacking: 'normal',
                	 stack: 'colaborador',
                	 data: [120,110,120,130,140,150,160,170,180,190,200,210]
                 },
                 {
                	 name: 'Outro centro de custo',
                	 type: 'column',
                	 stacking: 'normal',
                	 stack: 'colaborador',
                	 data: [85,115,125,135,145,155,165,175,185,195,205,215]
                 },
                 {
                	 name: 'Colaboradores',
                	 type: 'spline',
                	 yAxis: 1,
                	 data: [10,8,16,50,14,15,16,17,18,19,20,21],
                 }
             ]
		 });
	}
	
	/**
	 * Função responsável por renderizar o gráfico de barras detalhado do CC
	 */
	this.renderizarDetalhe = function(aCentroDeCusto){
		
		//TODO: corrigir gráfico conforme o renderizarBarra
		var mes = [];
		var hoje = new Date();
		var inicio = hoje.getMonth();
		var fim = inicio - 12;
		for(var m = fim; m < inicio; m++){
			mes.push(new Date(hoje.getFullYear(), m, 1));
		}
		
		for(var x in mes){
			mes[x] = 'TS '+(mes[x].getMonth()+1)+'/'+mes[x].getFullYear();
		}
		
		 $('#barra').highcharts({
			 chart: {
	            zoomType: 'xy'
	        },
	        plotOptions: {
	        	series: {
	                cursor: 'pointer',
               	events: {
               		click: function (e) {
               			_this.renderizarPizza();
               		}	
               	}
	            }
	        },
	        title: {
	            text: 'Evolução do centro de custo '+aCentroDeCusto
	            	+' nos últimos 12 meses'
	        },
	        xAxis: [{
	            categories: mes,
	            crosshair: true
	        }],
	        yAxis: [{
	            title: {
	                text: 'Custo'
	            }
	        }, {
	            title: {
	                text: 'Colaboradores'
	            },
	            opposite: true
	        }],
	        tooltip: {
	            shared: true
	        },
	        series: [
                {
               	 name: 'Hora extra',
               	 type: 'column',
               	 data: [105,115,125,135,145,155,165,175,185,195,205,215]
                },
                {
               	 name: 'Sobreaviso',
               	 type: 'column',
               	 data: [100,110,120,130,140,150,160,170,180,190,200,210]
                },
                {
               	 name: 'Colaboradores',
               	 type: 'spline',
               	 yAxis: 1,
               	 data: [10,11,12,13,14,15,16,17,18,19,20,21],
                }
            ]
		 });
	}
}