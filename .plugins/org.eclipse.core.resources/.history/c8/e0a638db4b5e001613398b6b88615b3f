app.controller("habilidadeOpcaoController", [
		"$filter",
		"$scope",
		"$cookies",
		"api",
		function($filter, $scope, $cookies, api) {
			$scope.usuario = $cookies.getObject('usuario');

			//gráficos
			$scope.grafico = new dashboardFinanceiroController_grafico(api);
			$scope.grafico.carregarTimesheet();
			
			//gerencia a tela a ser exibida
			$scope.tela = new Tela($scope);
			$scope.tela.ativar('tabela');
			
}]);


function dashboardFinanceiroController_grafico(aApi) {
	var _this = this;
	
	//referencias ao timesheet
	this.timesheet = '5';
	this.listaTimesheet = [];
	
	//séries de dados
	this.serieBarra = [];
	this.serieBarra2 = [];
	this.serieBarra3 = [];
	this.seriePizza = [];
	this.serieCentroDeCusto = [];
	this.centroDeCusto = "";
	
	/**
	 * Função responsável por listar os timesheet
	 */
	this.carregarTimesheet = function(){
		aApi.enviarApi("DashboardTimesheet.financeiroListarTimesheet",
			1,'')
		.success(function(aResp){
			if(aResp.error){
				alertaError(aResp.error.message);
				return;
			}
			_this.listaTimesheet = aResp.result;
			
			_this.timesheet = $(_this.listaTimesheet).get(-1).id;
			
			_this.init();
		})
		.error(function(aResp){
			alertaError(aResp);
		})
	}
	
	this.timesheetNome = function(){
		for(var i in _this.listaTimesheet){
			if(_this.listaTimesheet[i].id == _this.timesheet){
				return _this.listaTimesheet[i].mes+"/"+_this.listaTimesheet[i].ano;
			}
		}
	}
	
	/**
	 * Função resposável por carregar os dados gerais dos gráficos
	 */
	this.init = function(){
		aApi.enviarApi("DashboardTimesheet.financeiroExtraAndSobreaviso",
			1, _this.timesheet)
		.success(function(aResp){
			if(aResp.error){
				alertaError(aResp.error.message);
				return;
			}
			
			_this.serieBarra = aResp.result.barra;
			_this.serieBarra2 = aResp.result.barra2;
			_this.serieBarra3 = aResp.result.barra3;
			_this.renderizarBarra();
			_this.renderizarBarra2();
			_this.renderizarBarra3();
//			_this.seriePizza = aResp.result.pizza;
//			_this.renderizarPizza();
		})
		.error(function(aResp){
			alertaError(aResp);
		})
	}
	
	/**
	 * Função responsável por carregar os dados de um centro de custo
	 */
	this.detalhar = function(aPoint){
		_this.centroDeCusto = _this.serieBarra.nome[aPoint.index];
		aApi.enviarApi("DashboardTimesheet.financeiroExtraAndSobreavisoProjeto",
				1, _this.serieBarra.ccId[aPoint.index])
		.success(function(aResp){
			if(aResp.error){
				alertaError(aResp.error.message);
				return;
			}
			_this.serieCentroDeCusto =  aResp.result;
			_this.renderizarDetalhe();
			
		})
		.error(function(aResp){
			alertaError(aResp);
		})
	}
	
	/**
	 * Função responsável por renderizar o gráfico de pizza
	 */
	this.renderizarPizza = function(){
	    $('#pizza').highcharts({
	        chart: {
	            plotBackgroundColor: null,
	            plotBorderWidth: null,
	            plotShadow: false,
	            type: 'pie'
	        },
	        title: {
	            text: 'Custo de horas extras e sobreavisos'
	        },
	        tooltip: {
            	pointFormatter:function(){
                	return '<b>'+this.name+'</b>: R$ '+this.y.toLocaleString('pt-BR',{minimumFractionDigits: 2,maximumFractionDigits: 2});
                }
	        },
	        plotOptions: {
	            pie: {
	                allowPointSelect: true,
	                cursor: 'pointer',
	                dataLabels: {
	                    enabled: true,
	                    formatter:function(){
	                    	return '<b>'+this.key+'</b>: R$ '+this.y.toLocaleString('pt-BR',{minimumFractionDigits: 2,maximumFractionDigits: 2});
	                    }
	                }
	            }
	        },
	        series: [{
	            name: 'Custo',
	            data: _this.seriePizza
	        }]
	    });
    }

	/**
	 * Função responsável por renderizar o gráfico de barras geral
	 */
	this.renderizarBarra = function(){
	    $('#barra').highcharts({
		chart: {
		    zoomType: 'xy',
		    options3d: {
			enabled: true,
			alpha: 45,
			beta: 0
		    }
		},
		plotOptions: {
		    series: {
			cursor: 'pointer',
			events: {
			    click: function (e) {
				_this.detalhar(e.point);
			    }	
			}
		    }
		},
		title: {
		    text: 'Custo de horas extras e sobreavisos no timesheet '
			+_this.timesheetNome()
		},
		xAxis: [{
		    categories: _this.serieBarra.nome,
		    crosshair: true
		}],
		yAxis: [{
		    title: {
			text: 'Custo'
		    }
		}, {
		    title: {
			text: 'Colaboradores'
		    },
		    opposite: true
		}],
		tooltip: {
		    formatter: function () {
			var txt = '<table><tr><td colspan="4"><b style="size:1.2em">'
			    +this.x+'</b></td></tr>';
			console.info(this);
			
			$.each(this.points, function () {
			    var valor = "<td><b>R$</b></td> " +
			    '<td style="padding-left:3px; text-align:right"><b>'
			    +this.y.toLocaleString('pt-BR',
				    {minimumFractionDigits: 2,maximumFractionDigits: 2})
				    +'</td>';
			    
			    if(this.series.name == "Colaboradores"){
				valor = '<td>&nbsp;</td>'+
				'<td style="padding-left:3px; text-align:right"><b>'
				+this.y
				+'</td>';
			    }
			    txt += '<tr><td'
				+' style="background:'
				+this.series.color+'; color:'
				+this.series.color+'"'
				+'>--</td><td>&nbsp;&nbsp;'
				+this.series.name
				+'&nbsp;&nbsp;</td>'
				+ valor
				+'</b></td></tr>';
			});
			return txt+"</table>";
		    },
		    shared: true,
		    useHTML: true
		},
		series: [
		         {
		             name: 'Hora extra',
		             type: 'column',
		             stacking: 'normal',
		             stack: 'custo',
		             data: _this.serieBarra.horaExtra
		         },
		         {
		             name: 'Sobreaviso',
		             type: 'column',
		             stacking: 'normal',
		             stack: 'custo',
		             data: _this.serieBarra.sobreaviso
		         },
		         {
		             name: 'Do centro de custo',
		             type: 'column',
		             stacking: 'normal',
		             stack: 'colaborador',
		             data: _this.serieBarra.doCentroDeCusto
		         },
		         {
		             name: 'Outro centro de custo',
		             type: 'column',
		             stacking: 'normal',
		             stack: 'colaborador',
		             data: _this.serieBarra.outroCentroDeCusto
		         },
		         {
		             name: 'Colaboradores',
		             type: 'spline',
		             yAxis: 1,
		             data: _this.serieBarra.colaborador
		         }
		         ]
	    });
	}
	
	/**
	 * Função responsável por renderizar o gráfico de barras geral
	 */
	this.renderizarBarra2 = function(){
		 $('#barra2').highcharts({
			 chart: {
	            zoomType: 'xy',
	            options3d: {
	                enabled: true,
	                alpha: 45,
	                beta: 0
	            }
	        },
	        plotOptions: {
	        	series: {}
	        },
	        title: {
	            text: 'Custo de horas extras e sobreavisos por timesheet'
	        },
	        xAxis: [{
	            categories: _this.serieBarra2.timesheet,
	            crosshair: true
	        }],
	        yAxis: [{
	            title: {
	                text: 'Custo'
	            }
	        }],
	        tooltip: {
	        	formatter: function () {
	        		var txt = '<table><tr><td colspan="4"><b style="size:1.2em">'
	        			+this.x+'</b></td></tr>';
	        		
        			 $.each(this.points, function () {
        				 var valor = "<td><b>R$</b></td> " +
    				 		'<td style="padding-left:3px; text-align:right"><b>'
        				 	+this.y.toLocaleString('pt-BR',
    						 {minimumFractionDigits: 2,maximumFractionDigits: 2})
    						 +'</td>';
        				txt += '<tr><td'
    						+' style="background:'
    						+this.series.color+'; color:'
    						+this.series.color+'"'
    						+'>--</td><td>&nbsp;&nbsp;'
    						+this.series.name
    						+'&nbsp;&nbsp;</td>'
    						+ valor
    						+'</b></td></tr>';
        			 });
	                return txt+"</table>";
	            },
	            shared: true,
	            useHTML: true
	        },
	        series: [
                 {
                	 name: 'Hora extra',
                	 type: 'column',
                	 data: _this.serieBarra2.horaExtra
                 },
                 {
                	 name: 'Sobreaviso',
                	 type: 'column',
                	 data: _this.serieBarra2.sobreaviso
                 }
             ]
		 });
	}
	
	/**
	 * Função responsável por renderizar o gráfico de barras geral
	 */
	this.renderizarBarra3 = function(){
		 $('#barra3').highcharts({
			 chart: {
	            zoomType: 'xy',
	            options3d: {
	                enabled: true,
	                alpha: 45,
	                beta: 0
	            }
	        },
	        plotOptions: {
	        	series: {}
	        },
	        title: {
	            text: 'Custo de horas extras e sobreavisos por empresa do timesheet '
	        	+_this.timesheetNome()
	        },
	        xAxis: [{
	            categories: _this.serieBarra3.empresa,
	            crosshair: true
	        }],
	        yAxis: [{
	            title: {
	                text: 'Custo'
	            }
	        }],
	        tooltip: {
	        	formatter: function () {
	        		var txt = '<table><tr><td colspan="4"><b style="size:1.2em">'
	        			+this.x+'</b></td></tr>';
	        		
        			 $.each(this.points, function () {
        				 var valor = "<td><b>R$</b></td> " +
    				 		'<td style="padding-left:3px; text-align:right"><b>'
        				 	+this.y.toLocaleString('pt-BR',
    						 {minimumFractionDigits: 2,maximumFractionDigits: 2})
    						 +'</td>';
        				txt += '<tr><td'
    						+' style="background:'
    						+this.series.color+'; color:'
    						+this.series.color+'"'
    						+'>--</td><td>&nbsp;&nbsp;'
    						+this.series.name
    						+'&nbsp;&nbsp;</td>'
    						+ valor
    						+'</b></td></tr>';
        			 });
	                return txt+"</table>";
	            },
	            shared: true,
	            useHTML: true
	        },
	        series: [
                 {
                	 name: 'Hora extra',
                	 type: 'column',
                	 data: _this.serieBarra3.horaExtra
                 },
                 {
                	 name: 'Sobreaviso',
                	 type: 'column',
                	 data: _this.serieBarra3.sobreaviso
                 }
             ]
		 });
	}
	
	/**
	 * Função responsável por renderizar o gráfico de barras detalhado do CC
	 */
	this.renderizarDetalhe = function(){
		
		//TODO: corrigir gráfico conforme o renderizarBarra
		 $('#barra').highcharts({
			 chart: {
	            zoomType: 'xy'
	        },
	        plotOptions: {
	        	series: {
	                cursor: 'pointer',
               	events: {
               		click: function (e) {
               			_this.renderizarBarra();
               		}	
               	}
	            }
	        },
	        title: {
	            text: 'Evolução do centro de custo '+_this.centroDeCusto
	            	+' nos últimos 12 timesheets'
	        },
	        xAxis: [{
	            categories: _this.serieCentroDeCusto.timesheet,
	            crosshair: true
	        }],
	        yAxis: [{
	            title: {
	                text: 'Custo'
	            }
	        }, {
	            title: {
	                text: 'Colaboradores'
	            },
	            opposite: true
	        }],
	        tooltip: {
	        	formatter: function () {
	        		var txt = '<table><tr><td colspan="4"><b style="size:1.2em">'
	        			+this.x+'</b></td></tr>';
	        		
        			 $.each(this.points, function () {
        				 var valor = "<td><b>R$</b></td> " +
    				 		'<td style="padding-left:3px; text-align:right"><b>'
        				 	+this.y.toLocaleString('pt-BR',
    						 {minimumFractionDigits: 2,maximumFractionDigits: 2})
    						 +'</td>';
        				 
        				 if(this.series.name == "Colaboradores"){
        					 valor = '<td>&nbsp;</td>'+
	        					 '<td style="padding-left:3px; text-align:right"><b>'
	         				 	+this.y
	     						 +'</td>';
        				 }
        				txt += '<tr><td'
    						+' style="background:'
    						+this.series.color+'; color:'
    						+this.series.color+'"'
    						+'>--</td><td>&nbsp;&nbsp;'
    						+this.series.name
    						+'&nbsp;&nbsp;</td>'
    						+ valor
    						+'</b></td></tr>';
        			 });
	                return txt+"</table>";
	            },
	            shared: true,
	            useHTML: true
	        },
	        series: [
	                 
				{
					 name: 'Hora extra',
					 type: 'column',
					 stacking: 'normal',
					 stack: 'custo',
					 data: _this.serieCentroDeCusto.horaExtra
				},
				{
					 name: 'Sobreaviso',
					 type: 'column',
					 stacking: 'normal',
					 stack: 'custo',
					 data: _this.serieCentroDeCusto.sobreaviso
				},
				{
					 name: 'Do centro de custo',
					 type: 'column',
					 stacking: 'normal',
					 stack: 'colaborador',
					 data: _this.serieCentroDeCusto.doCentroDeCusto
				},
				{
					 name: 'Outro centro de custo',
					 type: 'column',
					 stacking: 'normal',
					 stack: 'colaborador',
					 data: _this.serieCentroDeCusto.outroCentroDeCusto
				},
				{
					 name: 'Colaboradores',
					 type: 'spline',
					 yAxis: 1,
					 data: _this.serieCentroDeCusto.colaborador
				}
            ]
		 });
	}
}